#!/bin/bash

usage() {
    echo "Usage: $0 [-h] [-o output_file] input_file"
    echo "  -h              Show this help message"
    echo "  -o output_file  Specify output filename (default: overwrite input file)"
    echo "  input_file      HTML file to optimize"
}

output_file=""
while getopts "ho:" opt; do
    case $opt in
        h) usage; exit 0 ;;
        o) output_file="$OPTARG" ;;
        *) usage; exit 1 ;;
    esac
done
shift $((OPTIND-1))

if [ $# -ne 1 ] || [ ! -f "$1" ]; then
    usage
    exit 1
fi

input_file="$1"
target_file="${output_file:-$input_file}"

n=$(grep -n 'data:application/octet-stream' "$input_file" | cut -f1 -d: | tail -n1)
sed "${n}d" "$input_file" | sed "$((n - 1))r wasm.optimized" > temp_file

html-minifier --collapse-whitespace --remove-comments --minify-js true --minify-css true --output "$target_file" temp_file && rm temp_file
