<script>
      document.getElementById('logo').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });

      document.getElementById('file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const output = document.getElementById('output');
            const program = e.target.result;
            output.innerText = "";
            const lines = program.split('\n');
            for(const line of lines) {
              if (line.trim()) {
                output.innerHTML += `> ${line}\\n`;
                await window.Module.cwrap("process_line", "string", ["string"], {async: true})(line);
              }
            };
          };
          reader.readAsText(file);
        }
      });
</script>
<script type="text/javascript">
    var resolveInputPromise;

    function createInputPromise() {
        window.awaitInputPromise = new Promise((resolve) => {
            resolveInputPromise = resolve;
        });
    }

    function scrollToBottom() {
        let screen = document.querySelector('.screen');
        if (screen) {
            setTimeout(() => {
                screen.scrollTop = screen.scrollHeight;
            }, 0);
        }
    }

    window.isAwaitingInput = false;
    createInputPromise();

    var Module = {
        preRun: [],
        postRun: [],
        print: (() => {
            var element = document.getElementById('output');
            if (element) element.innerHTML = ''; // clear browser cache
            return function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.log(text);
                if (element) {
                    element.innerHTML += text + "\\n";
                    scrollToBottom();
                }
            };
        })(),
        printErr: function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            console.error(text);
        },
        setStatus: function(text) {},
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        },
        onRuntimeInitialized: async function() {
            let output = document.getElementById('output');
            let input = document.getElementById('input');
            output.innerHTML = '';
            let process_line = Module.cwrap('process_line', 'string', ['string'], {
                async: true
            });
            let get_input_buffer = Module.cwrap('get_input_buffer', 'number', []);
            let input_buffer_ptr = get_input_buffer();

            let initial_output = await process_line("");
            output.innerHTML += initial_output;
            scrollToBottom();

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    let command = input.value;
                    input.value = '';

                    let command_display = `>${command}\\n`;
                    let current_output = output.innerHTML;
                    if (current_output.endsWith('\\n')) {
                        output.innerHTML = current_output + command_display;
                    } else {
                        output.innerHTML = current_output + "\\n" + command_display;
                    }
                    scrollToBottom();

                    if (window.isAwaitingInput) {
                        Module.stringToUTF8(command, input_buffer_ptr, 256);
                        resolveInputPromise();
                        createInputPromise();
                    } else {
                        let result = await process_line(command);
                        if (result) {
                            output.innerHTML += result;
                        }
                    }
                }
            });
        }
    };
    Module.setStatus('Downloading...');
</script>
{{{ SCRIPT }}}
</body>
</html>
